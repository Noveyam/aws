name: Deploy Resume Website

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js (for validation tools)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install validation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl bc
        # Install HTML validator (using html-validate which exists)
        npm install -g html-validate || echo "html-validate installation failed, skipping"
    
    - name: Validate project configuration
      run: |
        chmod +x scripts/validate-config.sh
        ./scripts/validate-config.sh || echo "Config validation completed with warnings"
    
    - name: Validate HTML files
      continue-on-error: true
      run: |
        if command -v html-validate &> /dev/null; then
          find website -name "*.html" -exec html-validate {} \; || true
        else
          echo "HTML validator not available, checking basic syntax..."
          for file in $(find website -name "*.html"); do
            if ! grep -q "<!DOCTYPE html>" "$file"; then
              echo "Warning: $file missing DOCTYPE"
            fi
          done
        fi
        echo "‚úì HTML validation completed (warnings are non-blocking)"
    
    - name: Validate CSS files
      run: |
        echo "Checking CSS files for basic syntax..."
        for file in $(find website -name "*.css"); do
          # Basic CSS validation - check for unclosed braces
          open_braces=$(grep -o '{' "$file" | wc -l)
          close_braces=$(grep -o '}' "$file" | wc -l)
          if [ "$open_braces" -ne "$close_braces" ]; then
            echo "Warning: $file has mismatched braces"
          else
            echo "‚úì $file syntax looks good"
          fi
        done
    
    - name: Check file sizes
      run: |
        echo "Checking for large files..."
        find website -type f -size +1M -exec ls -lh {} \; || true

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    
    strategy:
      matrix:
        environment: [dev, staging]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set environment configuration
      run: |
        chmod +x scripts/manage-environment.sh
        ./scripts/manage-environment.sh set ${{ matrix.environment }}
    
    - name: Terraform Init
      working-directory: terraform
      run: terraform init
    
    - name: Terraform Plan
      working-directory: terraform
      run: |
        terraform plan -out=tfplan-${{ matrix.environment }}
        terraform show -no-color tfplan-${{ matrix.environment }} > plan-${{ matrix.environment }}.txt
    
    - name: Comment PR with plan
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('terraform/plan-${{ matrix.environment }}.txt', 'utf8');
          const output = `#### Terraform Plan for ${{ matrix.environment }} ü™ê
          
          <details><summary>Show Plan</summary>
          
          \`\`\`terraform
          ${plan}
          \`\`\`
          
          </details>
          
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc
    
    - name: Deploy to development
      run: |
        chmod +x scripts/*.sh
        ./scripts/deploy-all.sh deploy dev
    
    - name: Run deployment tests
      run: |
        # Wait for deployment to be ready
        sleep 60
        # Test website accessibility
        if [ -f terraform-outputs.json ]; then
          WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
          curl -f "$WEBSITE_URL" || exit 1
        fi

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc
    
    - name: Deploy to staging
      run: |
        chmod +x scripts/*.sh
        ./scripts/deploy-all.sh deploy staging
    
    - name: Run staging tests
      run: |
        # Wait for deployment to be ready
        sleep 60
        # Test website accessibility and performance
        if [ -f terraform-outputs.json ]; then
          WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
          
          # Test accessibility
          curl -f "$WEBSITE_URL" || exit 1
          
          # Test HTTPS redirect
          HTTP_URL=$(echo "$WEBSITE_URL" | sed 's/https/http/')
          REDIRECT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HTTP_URL")
          if [ "$REDIRECT_STATUS" != "301" ] && [ "$REDIRECT_STATUS" != "302" ]; then
            echo "HTTPS redirect not working properly"
            exit 1
          fi
          
          # Test response time
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$WEBSITE_URL")
          # Use awk instead of bc for better compatibility
          if [ $(echo "$RESPONSE_TIME 3.0" | awk '{print ($1 > $2)}') -eq 1 ]; then
            echo "Response time too slow: ${RESPONSE_TIME}s"
            exit 1
          fi
        fi
    
    - name: Notify staging deployment
      if: success()
      run: |
        echo "‚úÖ Staging deployment successful"
        if [ -f terraform-outputs.json ]; then
          WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
          echo "üåê Staging URL: $WEBSITE_URL"
        fi

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, deploy-staging]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc
    
    - name: Deploy to production
      run: |
        chmod +x scripts/*.sh
        ENVIRONMENT="${{ github.event.inputs.environment || 'prod' }}"
        ./scripts/deploy-all.sh deploy "$ENVIRONMENT"
    
    - name: Run production tests
      run: |
        # Wait for deployment to be ready
        sleep 120
        # Comprehensive production tests
        if [ -f terraform-outputs.json ]; then
          WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
          
          # Test main website
          curl -f "$WEBSITE_URL" || exit 1
          
          # Test www redirect
          WWW_URL=$(jq -r '.www_website_url.value' terraform-outputs.json)
          curl -f "$WWW_URL" || exit 1
          
          # Test error page
          ERROR_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL/nonexistent")
          if [ "$ERROR_STATUS" != "404" ]; then
            echo "Error page not working properly"
            exit 1
          fi
          
          # Test SSL certificate
          echo | openssl s_client -servername $(echo "$WEBSITE_URL" | sed 's|https://||') -connect $(echo "$WEBSITE_URL" | sed 's|https://||'):443 2>/dev/null | openssl x509 -noout -dates
        fi
    
    - name: Create deployment tag
      if: success() && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"
    
    - name: Notify production deployment
      if: success()
      run: |
        echo "üéâ Production deployment successful!"
        if [ -f terraform-outputs.json ]; then
          WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
          echo "üåê Production URL: $WEBSITE_URL"
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Terraform security scan
      continue-on-error: true
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: 'terraform/'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      continue-on-error: true
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Check for secrets
      continue-on-error: true
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified