# GitLab CI/CD Pipeline for Resume Website
# Supports multi-environment deployment with validation and testing

stages:
  - validate
  - plan
  - deploy-dev
  - deploy-staging
  - deploy-prod
  - test

variables:
  AWS_DEFAULT_REGION: us-east-1
  TERRAFORM_VERSION: "1.6.0"
  TF_ROOT: terraform
  TF_STATE_NAME: resume-website

# Cache Terraform plugins and modules
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - ${TF_ROOT}/.terraform
    - ${TF_ROOT}/.terraform.lock.hcl

# Validation stage
validate:
  stage: validate
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl jq unzip
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update && apt-get install terraform=${TERRAFORM_VERSION}
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip && ./aws/install
  script:
    - echo "Validating project configuration..."
    - chmod +x scripts/validate-config.sh
    - ./scripts/validate-config.sh
    - echo "Validating Terraform configuration..."
    - cd ${TF_ROOT}
    - terraform fmt -check=true -diff=true
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Terraform plan for different environments
.terraform_plan_template: &terraform_plan
  stage: plan
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl jq unzip
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update && apt-get install terraform=${TERRAFORM_VERSION}
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip && ./aws/install
  script:
    - echo "Planning Terraform deployment for ${ENVIRONMENT}..."
    - chmod +x scripts/manage-environment.sh
    - ./scripts/manage-environment.sh set ${ENVIRONMENT}
    - cd ${TF_ROOT}
    - terraform init
    - terraform plan -out=tfplan-${ENVIRONMENT}
    - terraform show -no-color tfplan-${ENVIRONMENT} > plan-${ENVIRONMENT}.txt
  artifacts:
    name: "terraform-plan-${ENVIRONMENT}"
    paths:
      - ${TF_ROOT}/tfplan-${ENVIRONMENT}
      - ${TF_ROOT}/plan-${ENVIRONMENT}.txt
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

plan:dev:
  <<: *terraform_plan
  variables:
    ENVIRONMENT: dev

plan:staging:
  <<: *terraform_plan
  variables:
    ENVIRONMENT: staging

plan:prod:
  <<: *terraform_plan
  variables:
    ENVIRONMENT: prod
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Development deployment
deploy:dev:
  stage: deploy-dev
  image: ubuntu:22.04
  environment:
    name: development
    url: https://dev.noveycloud
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl jq unzip bc
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update && apt-get install terraform=${TERRAFORM_VERSION}
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip && ./aws/install
  script:
    - echo "Deploying to development environment..."
    - chmod +x scripts/deploy-all.sh
    - ./scripts/deploy-all.sh deploy dev
    - echo "Running basic tests..."
    - sleep 60
    - |
      if [ -f terraform-outputs.json ]; then
        WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
        echo "Testing website: $WEBSITE_URL"
        curl -f "$WEBSITE_URL" || exit 1
        echo "‚úÖ Development deployment successful"
      fi
  artifacts:
    name: "dev-deployment"
    paths:
      - terraform-outputs.json
      - complete-deployment.log
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

# Staging deployment
deploy:staging:
  stage: deploy-staging
  image: ubuntu:22.04
  environment:
    name: staging
    url: https://staging.noveycloud
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl jq unzip bc openssl
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update && apt-get install terraform=${TERRAFORM_VERSION}
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip && ./aws/install
  script:
    - echo "Deploying to staging environment..."
    - chmod +x scripts/deploy-all.sh
    - ./scripts/deploy-all.sh deploy staging
    - echo "Running staging tests..."
    - sleep 60
    - |
      if [ -f terraform-outputs.json ]; then
        WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
        echo "Testing website: $WEBSITE_URL"
        
        # Test main website
        curl -f "$WEBSITE_URL" || exit 1
        
        # Test HTTPS redirect
        HTTP_URL=$(echo "$WEBSITE_URL" | sed 's/https/http/')
        REDIRECT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HTTP_URL")
        if [ "$REDIRECT_STATUS" != "301" ] && [ "$REDIRECT_STATUS" != "302" ]; then
          echo "‚ùå HTTPS redirect not working"
          exit 1
        fi
        
        # Test response time
        RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$WEBSITE_URL")
        if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
          echo "‚ùå Response time too slow: ${RESPONSE_TIME}s"
          exit 1
        fi
        
        echo "‚úÖ Staging deployment and tests successful"
      fi
  artifacts:
    name: "staging-deployment"
    paths:
      - terraform-outputs.json
      - complete-deployment.log
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Production deployment
deploy:prod:
  stage: deploy-prod
  image: ubuntu:22.04
  environment:
    name: production
    url: https://noveycloud
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl jq unzip bc openssl
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update && apt-get install terraform=${TERRAFORM_VERSION}
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip && ./aws/install
  script:
    - echo "Deploying to production environment..."
    - chmod +x scripts/deploy-all.sh
    - ./scripts/deploy-all.sh deploy prod
    - echo "Running production tests..."
    - sleep 120
    - |
      if [ -f terraform-outputs.json ]; then
        WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
        WWW_URL=$(jq -r '.www_website_url.value' terraform-outputs.json)
        
        echo "Testing main website: $WEBSITE_URL"
        curl -f "$WEBSITE_URL" || exit 1
        
        echo "Testing www redirect: $WWW_URL"
        curl -f "$WWW_URL" || exit 1
        
        # Test error page
        ERROR_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL/nonexistent")
        if [ "$ERROR_STATUS" != "404" ]; then
          echo "‚ùå Error page not working properly"
          exit 1
        fi
        
        # Test SSL certificate
        DOMAIN=$(echo "$WEBSITE_URL" | sed 's|https://||')
        echo | openssl s_client -servername "$DOMAIN" -connect "$DOMAIN":443 2>/dev/null | openssl x509 -noout -dates
        
        echo "üéâ Production deployment successful!"
        echo "üåê Live at: $WEBSITE_URL"
      fi
  artifacts:
    name: "prod-deployment"
    paths:
      - terraform-outputs.json
      - complete-deployment.log
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_PIPELINE_SOURCE == "web"

# Performance and security tests
test:performance:
  stage: test
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl jq
  script:
    - echo "Running performance tests..."
    - |
      if [ -f terraform-outputs.json ]; then
        WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
        
        # Test page load time
        for i in {1..5}; do
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$WEBSITE_URL")
          echo "Test $i: ${RESPONSE_TIME}s"
        done
        
        # Test different pages
        curl -o /dev/null -s -w "Index page: %{time_total}s\n" "$WEBSITE_URL"
        curl -o /dev/null -s -w "Error page: %{time_total}s\n" "$WEBSITE_URL/404"
        
        echo "‚úÖ Performance tests completed"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

test:security:
  stage: test
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl jq openssl
  script:
    - echo "Running security tests..."
    - |
      if [ -f terraform-outputs.json ]; then
        WEBSITE_URL=$(jq -r '.website_url.value' terraform-outputs.json)
        DOMAIN=$(echo "$WEBSITE_URL" | sed 's|https://||')
        
        # Test SSL configuration
        echo "Testing SSL configuration..."
        SSL_GRADE=$(curl -s "https://api.ssllabs.com/api/v3/analyze?host=$DOMAIN&publish=off&startNew=on&all=done" | jq -r '.endpoints[0].grade // "Unknown"')
        echo "SSL Grade: $SSL_GRADE"
        
        # Test security headers
        echo "Testing security headers..."
        HEADERS=$(curl -s -I "$WEBSITE_URL")
        
        if echo "$HEADERS" | grep -i "strict-transport-security"; then
          echo "‚úÖ HSTS header present"
        else
          echo "‚ö†Ô∏è HSTS header missing"
        fi
        
        if echo "$HEADERS" | grep -i "x-content-type-options"; then
          echo "‚úÖ X-Content-Type-Options header present"
        else
          echo "‚ö†Ô∏è X-Content-Type-Options header missing"
        fi
        
        echo "‚úÖ Security tests completed"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# Cleanup job for failed deployments
cleanup:
  stage: deploy-prod
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl jq unzip
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    - apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - apt-get update && apt-get install terraform=${TERRAFORM_VERSION}
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip && ./aws/install
  script:
    - echo "Running cleanup for failed deployment..."
    - chmod +x scripts/deploy-website.sh
    - ./scripts/deploy-website.sh rollback || echo "No rollback needed"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_failure
  allow_failure: true